<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Data Explorer - Canadian Muslim Census</title>
  <meta name="description" content="Advanced demographic analytics and interactive data exploration for Canadian Muslim population insights.">
  <meta name="keywords" content="muslim demographics canada, data explorer, demographic analysis, population statistics">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Chart.js and additional visualization libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
  <!-- CSV & XLSX parsers for client-side PUMF ingestion -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">

  <style>
    :root {
      /* Design System Variables (same as index.html) */
      --color-primary-50: #eff6ff;
      --color-primary-100: #dbeafe;
      --color-primary-500: #3b82f6;
      --color-primary-600: #2563eb;
      --color-primary-700: #1d4ed8;
      --color-primary-900: #1e3a8a;
      
      --color-success-50: #ecfdf5;
      --color-success-500: #10b981;
      --color-warning-50: #fffbeb;
      --color-warning-500: #f59e0b;
      --color-error-50: #fef2f2;
      --color-error-500: #ef4444;
      
      --color-gray-50: #f9fafb;
      --color-gray-100: #f3f4f6;
      --color-gray-200: #e5e7eb;
      --color-gray-300: #d1d5db;
      --color-gray-400: #9ca3af;
      --color-gray-500: #6b7280;
      --color-gray-600: #4b5563;
      --color-gray-700: #374151;
      --color-gray-800: #1f2937;
      --color-gray-900: #111827;
      
      --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      
      --space-xs: 0.5rem;
      --space-sm: 0.75rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
      --space-2xl: 3rem;
      --space-3xl: 4rem;
      
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-sans);
      line-height: 1.6;
      color: var(--color-gray-900);
      background-color: var(--color-gray-50);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header Styles (same as index.html) */
    .header {
      background: white;
      border-bottom: 1px solid var(--color-gray-200);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--space-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 80px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      text-decoration: none;
      color: var(--color-gray-900);
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--color-primary-500), var(--color-primary-700));
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: 600;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--color-gray-900);
    }

    .nav {
      display: flex;
      gap: var(--space-lg);
      align-items: center;
    }

    .nav-item {
      color: var(--color-gray-600);
      text-decoration: none;
      font-weight: 500;
      font-size: 15px;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
    }

    .nav-item:hover, .nav-item.active {
      color: var(--color-primary-600);
      background-color: var(--color-primary-50);
    }

    .search-container {
      position: relative;
      width: 320px;
    }

    .search-input {
      width: 100%;
      padding: var(--space-sm) var(--space-md) var(--space-sm) 40px;
      border: 1px solid var(--color-gray-300);
      border-radius: var(--radius-lg);
      background: var(--color-gray-50);
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--color-primary-500);
      background: white;
      box-shadow: 0 0 0 3px var(--color-primary-50);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-gray-400);
    }

    /* Enhanced Hero-style Page Header with Deep Teal */
    .page-header {
      background: linear-gradient(135deg, #0f766e, #134e4a);
      color: white;
      padding: var(--space-3xl) 0;
      text-align: center;
      margin-bottom: var(--space-2xl);
    }

    .page-header-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--space-lg);
    }

    .page-title {
      font-size: 48px;
      font-weight: 800;
      color: white;
      margin-bottom: var(--space-lg);
      line-height: 1.1;
    }

    .page-subtitle {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.9);
      max-width: 700px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Data Explorer Layout */
    .explorer-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 var(--space-lg) var(--space-xl);
    }

    /* Filter Panel */
    .filter-panel {
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      border: 1px solid var(--color-gray-200);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--space-xl);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-lg);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .filter-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .filter-select {
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-gray-300);
      border-radius: var(--radius-md);
      background: white;
      font-size: 14px;
      color: var(--color-gray-700);
      transition: all 0.2s ease;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--color-primary-500);
      box-shadow: 0 0 0 3px var(--color-primary-50);
    }

    /* Analysis Grid */
    .analysis-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xl);
      margin-bottom: var(--space-2xl);
    }

    .analysis-card {
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      border: 1px solid var(--color-gray-200);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .analysis-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-lg);
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--color-gray-900);
    }

    .card-actions {
      display: flex;
      gap: var(--space-sm);
    }

    .action-btn {
      padding: var(--space-xs) var(--space-sm);
      border: 1px solid var(--color-gray-300);
      border-radius: var(--radius-sm);
      background: white;
      color: var(--color-gray-600);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .action-btn:hover {
      border-color: var(--color-primary-500);
      color: var(--color-primary-600);
    }

    .chart-container {
      height: 300px;
      position: relative;
    }

    /* StatCan Survey Analysis Section */
    .survey-analysis-section {
      background: linear-gradient(135deg, var(--color-primary-50), var(--color-success-50));
      border-radius: var(--radius-xl);
      padding: var(--space-2xl);
      margin-bottom: var(--space-2xl);
      border: 2px solid var(--color-primary-200);
    }

    .survey-header {
      text-align: center;
      margin-bottom: var(--space-xl);
    }

    /* PUMF Controls */
    .pumf-controls {
      background: white;
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
    }

    .pumf-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--space-lg);
      align-items: end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .control-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .control-select, .control-input {
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-gray-300);
      border-radius: var(--radius-md);
      background: white;
      font-size: 14px;
      color: var(--color-gray-700);
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: var(--space-xl);
    }

    @media (max-width: 992px) {
      .results-grid { grid-template-columns: 1fr; }
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: white;
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .preview-table th, .preview-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--color-gray-100);
    }

    .preview-table th { background: var(--color-gray-50); text-align: left; }

    .note {
      font-size: 13px;
      color: var(--color-gray-600);
    }

    .survey-title {
      font-size: 28px;
      font-weight: 800;
      color: var(--color-gray-900);
      margin-bottom: var(--space-md);
    }

    .survey-description {
      font-size: 16px;
      color: var(--color-gray-700);
      max-width: 600px;
      margin: 0 auto;
    }

    .survey-upload-area {
      background: white;
      border: 2px dashed var(--color-primary-300);
      border-radius: var(--radius-lg);
      padding: var(--space-2xl);
      text-align: center;
      margin-bottom: var(--space-lg);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .survey-upload-area:hover {
      border-color: var(--color-primary-500);
      background: var(--color-primary-50);
    }

    .upload-icon {
      font-size: 48px;
      color: var(--color-primary-500);
      margin-bottom: var(--space-md);
    }

    .upload-text {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-gray-800);
      margin-bottom: var(--space-sm);
    }

    .upload-subtext {
      font-size: 14px;
      color: var(--color-gray-600);
    }

    .analysis-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-lg);
    }

    .feature-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      border: 1px solid var(--color-gray-200);
      text-align: center;
    }

    .feature-icon {
      font-size: 32px;
      margin-bottom: var(--space-md);
    }

    .feature-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-sm);
    }

    .feature-description {
      font-size: 14px;
      color: var(--color-gray-600);
      line-height: 1.5;
    }

    /* Data Table */
    .data-table-section {
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      border: 1px solid var(--color-gray-200);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--space-2xl);
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
    }

    .table-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--color-gray-900);
    }

    .table-actions {
      display: flex;
      gap: var(--space-sm);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: var(--color-gray-50);
      padding: var(--space-md);
      text-align: left;
      font-weight: 600;
      color: var(--color-gray-800);
      border-bottom: 2px solid var(--color-gray-200);
    }

    .data-table td {
      padding: var(--space-md);
      border-bottom: 1px solid var(--color-gray-100);
      color: var(--color-gray-700);
    }

    .data-table tbody tr:hover {
      background: var(--color-gray-50);
    }

    .metric-value {
      font-weight: 600;
      color: var(--color-gray-900);
    }

    .trend-positive {
      color: var(--color-success-500);
    }

    .trend-negative {
      color: var(--color-error-500);
    }

    /* Buttons */
    .btn {
      padding: var(--space-md) var(--space-lg);
      border-radius: var(--radius-lg);
      font-weight: 600;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      transition: all 0.2s ease;
      border: 2px solid transparent;
      cursor: pointer;
    }

    .btn-primary {
      background: var(--color-primary-600);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-primary-700);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      color: white;
    }

    .btn-secondary {
      background: white;
      color: var(--color-gray-700);
      border-color: var(--color-gray-300);
    }

    .btn-secondary:hover {
      border-color: var(--color-primary-500);
      color: var(--color-primary-600);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-success {
      background: var(--color-success-500);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      color: white;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .header-content {
        padding: 0 var(--space-md);
        min-height: 64px;
      }
      
      .nav {
        display: flex;
        gap: var(--space-md);
        flex-wrap: wrap;
      }
      
      .search-container {
        width: 200px;
      }
      
      .page-header {
        padding: var(--space-2xl) 0;
      }
      
      .page-header-container {
        padding: 0 var(--space-md);
      }
      
      .page-title {
        font-size: 32px;
      }
      
      .page-subtitle {
        font-size: 16px;
      }
      
      .explorer-container {
        padding: 0 var(--space-md) var(--space-xl);
      }
      
      .analysis-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-grid {
        grid-template-columns: 1fr;
      }
      
      .analysis-features {
        grid-template-columns: 1fr;
      }

      .table-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-md);
      }

      .data-table {
        font-size: 14px;
      }
    }

    /* Loading States */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--color-gray-500);
    }

    .spinner {
      border: 3px solid var(--color-gray-200);
      border-top: 3px solid var(--color-primary-500);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-right: var(--space-md);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fadeInUp {
      animation: fadeInUp 0.6s ease-out;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="index.html" class="logo">
        <div class="logo-icon">📊</div>
        <span class="logo-text">Canadian Muslim Census</span>
      </a>
      
      <nav class="nav">
        <a href="index.html" class="nav-item">Dashboard</a>
        <a href="#" class="nav-item active">Data Explorer</a>
        <a href="about.html" class="nav-item">Research</a>
        <a href="about.html" class="nav-item">About</a>
        <a href="blog.html" class="nav-item">Blog</a>
        <a href="calgary-2025.html" class="nav-item">Calgary Municipal Election 2025</a>
      </nav>
      
      <div class="search-container">
        <input type="text" class="search-input" placeholder="Search demographics, insights..." id="searchInput">
        <i class="bi bi-search search-icon"></i>
      </div>
    </div>
  </header>

  <!-- Enhanced Hero-style Page Header -->
  <section class="page-header">
    <div class="page-header-container">
      <h1 class="page-title animate-fadeInUp">Advanced Data Explorer</h1>
      <p class="page-subtitle animate-fadeInUp" style="animation-delay: 0.2s">
        Interactive analytics platform for comprehensive demographic research and statistical analysis of Canada's Muslim population
      </p>
      <div class="data-source-note" style="color: rgba(255, 255, 255, 0.9); font-size: 13px; margin-top: 8px;">
        Contains information licensed under the Statistics Canada Open Licence.
      </div>
    </div>
  </section>

  <main class="explorer-container">
    <!-- Filter Panel -->
    <div class="filter-panel animate-fadeInUp" style="animation-delay: 0.1s">
      <div class="filter-grid">
        <div class="filter-group">
          <label class="filter-label">Geographic Scope</label>
          <select class="filter-select" id="geographicFilter" onchange="updateAnalysis()">
            <option value="canada">All of Canada</option>
            <option value="provinces">By Province</option>
            <option value="cities">Major Cities</option>
            <option value="regions">Regional Analysis</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Time Period</label>
          <select class="filter-select" id="timeFilter" onchange="updateAnalysis()">
            <option value="2021">2021 Census</option>
            <option value="2016">2016 Census</option>
            <option value="2011">2011 Census</option>
            <option value="historical">Historical Trend</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Demographic Focus</label>
          <select class="filter-select" id="demographicFilter" onchange="updateAnalysis()">
            <option value="all">All Demographics</option>
            <option value="age">Age Distribution</option>
            <option value="origin">Cultural Origins</option>
            <option value="language">Languages</option>
            <option value="education">Education Levels</option>
            <option value="employment">Employment</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Analysis Type</label>
          <select class="filter-select" id="analysisFilter" onchange="updateAnalysis()">
            <option value="overview">Overview</option>
            <option value="comparative">Comparative</option>
            <option value="trends">Trend Analysis</option>
            <option value="projections">Projections</option>
          </select>
        </div>
      </div>
    </div>

    <!-- StatCan Survey Analysis Section -->
    <div class="survey-analysis-section animate-fadeInUp" style="animation-delay: 0.2s">
      <div class="survey-header">
        <h2 class="survey-title">StatCan Survey Integration & Analysis</h2>
        <p class="survey-description">
          Upload Statistics Canada survey data to unlock advanced cross-tabulation analysis, 
          demographic modeling, and predictive insights with our proprietary analytics engine.
        </p>
      </div>

      <div class="survey-upload-area" onclick="handleFileUpload()" id="uploadArea">
        <div class="upload-icon">📊</div>
        <div class="upload-text">Upload StatCan Survey Data</div>
        <div class="upload-subtext">Drag & drop CSV, XLSX, or SAV files • Max 100MB</div>
        <input type="file" id="fileInput" style="display: none;" accept=".csv,.xlsx,.xls,.sav" onchange="processFile(event)">
      </div>

      <div class="pumf-controls" id="pumfUrlLoader">
        <div class="pumf-grid">
          <div class="control-group" style="grid-column: 1 / -1;">
            <label class="control-label">Load from URL (optional)</label>
            <div style="display:flex; gap: 8px;">
              <input type="url" id="pumfUrlInput" class="control-input" placeholder="https://.../statcan_pumf.csv or .xlsx">
              <button class="btn btn-secondary" id="pumfUrlBtn"><i class="bi bi-link-45deg"></i> Load URL</button>
            </div>
            <div class="note">Note: Remote files must allow CORS; otherwise upload the file above.</div>
          </div>
        </div>
      </div>

      <div class="pumf-controls" id="pumfControls" style="display:none;">
        <div class="pumf-grid">
          <div class="control-group">
            <label class="control-label">Row Variable</label>
            <select id="rowVar" class="control-select"></select>
          </div>
          <div class="control-group">
            <label class="control-label">Column Variable</label>
            <select id="colVar" class="control-select"></select>
          </div>
          <div class="control-group">
            <label class="control-label">Weight Variable</label>
            <select id="weightVar" class="control-select"></select>
          </div>
          <div class="control-group">
            <label class="control-label">Measure</label>
            <select id="measureType" class="control-select">
              <option value="weighted">Weighted Count</option>
              <option value="rowPct">Row %</option>
              <option value="colPct">Column %</option>
            </select>
          </div>
          <div style="display:flex; gap: 8px;">
            <button class="btn btn-primary" id="generateCrosstabBtn"><i class="bi bi-table"></i> Generate Crosstab</button>
            <button class="btn btn-secondary" id="downloadCrosstabBtn"><i class="bi bi-download"></i> Export CSV</button>
          </div>
        </div>
        <div id="pumfStatus" class="note" style="margin-top: 8px;"></div>
      </div>

      <div id="pumfResults" style="display:none;">
        <div class="results-grid">
          <div class="analysis-card">
            <div class="card-header"><h3 class="card-title">Weighted Crosstab</h3></div>
            <div class="chart-container" style="height: 360px;">
              <canvas id="pumfChart"></canvas>
            </div>
          </div>
          <div class="analysis-card">
            <div class="card-header"><h3 class="card-title">Data Preview</h3></div>
            <div style="max-height: 360px; overflow:auto;">
              <table class="preview-table" id="pumfPreviewTable"></table>
            </div>
          </div>
        </div>
        <div class="analysis-card" style="margin-top: var(--space-xl);">
          <div class="card-header"><h3 class="card-title">Crosstab Table</h3></div>
          <div style="overflow:auto;">
            <table class="data-table" id="pumfResultTable"></table>
          </div>
        </div>
        <div class="note" style="margin-top: 10px;">Data source: Statistics Canada PUMF. Ensure correct application of survey weights and filters for your analysis scope.</div>
        <div class="analysis-card" style="margin-top: var(--space-xl);">
          <div class="card-header"><h3 class="card-title">Summary Statistics</h3></div>
          <div id="pumfSummary" class="note">Load a file to see variable counts, missingness, and weight totals.</div>
        </div>
      </div>

      <div class="analysis-features">
        <div class="feature-card">
          <div class="feature-icon">🔍</div>
          <div class="feature-title">Cross-Tabulation Analysis</div>
          <div class="feature-description">
            Generate detailed cross-tabs between demographic variables with statistical significance testing
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon">📈</div>
          <div class="feature-title">Predictive Modeling</div>
          <div class="feature-description">
            Build demographic projection models using machine learning algorithms and trend analysis
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon">🗺️</div>
          <div class="feature-title">Geographic Mapping</div>
          <div class="feature-description">
            Visualize survey responses on interactive maps with heat mapping and cluster analysis
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon">📋</div>
          <div class="feature-title">Custom Reports</div>
          <div class="feature-description">
            Generate publication-ready reports with charts, tables, and statistical summaries
          </div>
        </div>
      </div>
    </div>

    <!-- Analysis Grid -->
    <div class="analysis-grid animate-fadeInUp" style="animation-delay: 0.3s">
      <div class="analysis-card">
        <div class="card-header">
          <h3 class="card-title">Population Distribution</h3>
          <div class="card-actions">
            <button class="action-btn" onclick="exportChart('population')">
              <i class="bi bi-download"></i> Export
            </button>
            <button class="action-btn" onclick="fullscreen('populationChart')">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="populationChart"></canvas>
        </div>
      </div>

      <div class="analysis-card">
        <div class="card-header">
          <h3 class="card-title">Age Demographics</h3>
          <div class="card-actions">
            <button class="action-btn" onclick="exportChart('age')">
              <i class="bi bi-download"></i> Export
            </button>
            <button class="action-btn" onclick="fullscreen('ageChart')">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="ageChart"></canvas>
        </div>
      </div>

      <div class="analysis-card">
        <div class="card-header">
          <h3 class="card-title">Economic Indicators</h3>
          <div class="card-actions">
            <button class="action-btn" onclick="exportChart('economic')">
              <i class="bi bi-download"></i> Export
            </button>
            <button class="action-btn" onclick="fullscreen('economicChart')">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="economicChart"></canvas>
        </div>
      </div>

      <div class="analysis-card">
        <div class="card-header">
          <h3 class="card-title">Educational Attainment</h3>
          <div class="card-actions">
            <button class="action-btn" onclick="exportChart('education')">
              <i class="bi bi-download"></i> Export
            </button>
            <button class="action-btn" onclick="fullscreen('educationChart')">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="educationChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Data Table Section -->
    <div class="data-table-section animate-fadeInUp" style="animation-delay: 0.4s">
      <div class="table-header">
        <h3 class="table-title">Detailed Demographics Table</h3>
        <div class="table-actions">
          <button class="btn btn-secondary" onclick="exportTable()">
            <i class="bi bi-download"></i>
            Export CSV
          </button>
          <button class="btn btn-primary" onclick="generateReport()">
            <i class="bi bi-file-earmark-text"></i>
            Generate Report
          </button>
        </div>
      </div>
      
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>Province/Territory</th>
              <th>Muslim Population</th>
              <th>Percentage of Total</th>
              <th>Growth Rate (2016-2021)</th>
              <th>Median Age</th>
              <th>Post-Secondary Education</th>
              <th>Employment Rate</th>
            </tr>
          </thead>
          <tbody id="dataTableBody">
            <tr>
              <td><strong>Ontario</strong></td>
              <td class="metric-value">1,194,115</td>
              <td class="metric-value">6.7%</td>
              <td class="trend-positive">+29.8%</td>
              <td>29 years</td>
              <td>62%</td>
              <td>87.2%</td>
            </tr>
            <tr>
              <td><strong>Quebec</strong></td>
              <td class="metric-value">434,325</td>
              <td class="metric-value">5.1%</td>
              <td class="trend-positive">+27.1%</td>
              <td>31 years</td>
              <td>58%</td>
              <td>84.5%</td>
            </tr>
            <tr>
              <td><strong>Alberta</strong></td>
              <td class="metric-value">212,430</td>
              <td class="metric-value">4.8%</td>
              <td class="trend-positive">+35.2%</td>
              <td>28 years</td>
              <td>65%</td>
              <td>89.1%</td>
            </tr>
            <tr>
              <td><strong>British Columbia</strong></td>
              <td class="metric-value">154,735</td>
              <td class="metric-value">3.0%</td>
              <td class="trend-positive">+23.4%</td>
              <td>32 years</td>
              <td>59%</td>
              <td>86.8%</td>
            </tr>
            <tr>
              <td><strong>Manitoba</strong></td>
              <td class="metric-value">28,570</td>
              <td class="metric-value">2.1%</td>
              <td class="trend-positive">+18.9%</td>
              <td>30 years</td>
              <td>54%</td>
              <td>83.7%</td>
            </tr>
            <tr>
              <td><strong>Saskatchewan</strong></td>
              <td class="metric-value">14,225</td>
              <td class="metric-value">1.2%</td>
              <td class="trend-positive">+22.1%</td>
              <td>29 years</td>
              <td>56%</td>
              <td>85.3%</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
      <button class="btn btn-success" onclick="scheduleAnalysis()">
        <i class="bi bi-clock"></i>
        Schedule Analysis
      </button>
      <button class="btn btn-primary" onclick="requestCustomAnalysis()">
        <i class="bi bi-gear"></i>
        Custom Analysis
      </button>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSeBiw3MyaTyG9Xofql2EALD9-mvPXeySmuH_4yayRDHSOD5NQ/viewform?usp=header" class="btn btn-secondary">
        <i class="bi bi-person-plus"></i>
        Contribute Data
      </a>
    </div>
  </main>

  <script>
    // Initialize all components when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeCharts();
      setupEventListeners();
    });

    // Initialize all charts
    function initializeCharts() {
      initPopulationChart();
      initAgeChart();
      initEconomicChart();
      initEducationChart();
    }

    // Population Distribution Chart
    function initPopulationChart() {
      const ctx = document.getElementById('populationChart').getContext('2d');
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Ontario', 'Quebec', 'Alberta', 'BC', 'Manitoba', 'Saskatchewan'],
          datasets: [{
            label: 'Muslim Population',
            data: [1194115, 434325, 212430, 154735, 28570, 14225],
            backgroundColor: [
              '#3b82f6',
              '#10b981',
              '#f59e0b',
              '#ef4444',
              '#8b5cf6',
              '#06b6d4'
            ],
            borderRadius: 4,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  return 'Population: ' + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: '#f1f5f9'
              },
              ticks: {
                color: '#6b7280',
                callback: function(value) {
                  return (value / 1000).toFixed(0) + 'K';
                }
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#6b7280'
              }
            }
          }
        }
      });
    }

    // Age Distribution Chart
    function initAgeChart() {
      const ctx = document.getElementById('ageChart').getContext('2d');
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['0-14', '15-24', '25-34', '35-44', '45-54', '55-64', '65+'],
          datasets: [{
            label: 'Muslim Population',
            data: [28.2, 16.8, 20.1, 17.9, 10.5, 4.8, 1.7],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 5
          }, {
            label: 'General Population',
            data: [15.3, 11.8, 14.2, 16.1, 17.8, 15.4, 9.4],
            borderColor: '#94a3b8',
            backgroundColor: 'rgba(148, 163, 184, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            pointBackgroundColor: '#94a3b8',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: '#f1f5f9'
              },
              ticks: {
                color: '#6b7280',
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#6b7280'
              }
            }
          }
        }
      });
    }

    // Economic Indicators Chart
    function initEconomicChart() {
      const ctx = document.getElementById('economicChart').getContext('2d');
      
      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Employment Rate', 'Median Income', 'Business Ownership', 'Home Ownership', 'Educational Investment'],
          datasets: [{
            label: 'Muslim Population',
            data: [87, 75, 12, 68, 95],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2
          }, {
            label: 'National Average',
            data: [89, 80, 15, 73, 85],
            borderColor: '#94a3b8',
            backgroundColor: 'rgba(148, 163, 184, 0.1)',
            pointBackgroundColor: '#94a3b8',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20
              }
            }
          },
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              ticks: {
                stepSize: 20
              }
            }
          }
        }
      });
    }

    // Education Chart
    function initEducationChart() {
      const ctx = document.getElementById('educationChart').getContext('2d');
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['University Degree', 'College Diploma', 'High School', 'Graduate Degree', 'Other'],
          datasets: [{
            data: [35, 25, 20, 15, 5],
            backgroundColor: [
              '#3b82f6',
              '#10b981',
              '#f59e0b',
              '#ef4444',
              '#8b5cf6'
            ],
            borderWidth: 0,
            hoverOffset: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            }
          },
          cutout: '60%'
        }
      });
    }

    // Event Listeners
    function setupEventListeners() {
      // File upload drag and drop
      const uploadArea = document.getElementById('uploadArea');
      
      uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = '#3b82f6';
        uploadArea.style.backgroundColor = '#eff6ff';
      });
      
      uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = '#93c5fd';
        uploadArea.style.backgroundColor = 'white';
      });
      
      uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.style.borderColor = '#93c5fd';
        uploadArea.style.backgroundColor = 'white';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          processFile({ target: { files: files } });
        }
      });

      // URL loader
      const urlBtn = document.getElementById('pumfUrlBtn');
      if (urlBtn) {
        urlBtn.addEventListener('click', function() {
          const url = (document.getElementById('pumfUrlInput') || {}).value || '';
          if (!url) { alert('Enter a valid URL to load.'); return; }
          loadPUMFFromURL(url);
        });
      }

      // Generate crosstab
      const genBtn = document.getElementById('generateCrosstabBtn');
      if (genBtn) {
        genBtn.addEventListener('click', function() {
          generateCrosstabAndRender();
        });
      }

      const dlBtn = document.getElementById('downloadCrosstabBtn');
      if (dlBtn) {
        dlBtn.addEventListener('click', function() {
          downloadCrosstabCSV();
        });
      }
    }

    // Analysis Update Function
    function updateAnalysis() {
      const geographic = document.getElementById('geographicFilter').value;
      const time = document.getElementById('timeFilter').value;
      const demographic = document.getElementById('demographicFilter').value;
      const analysis = document.getElementById('analysisFilter').value;
      
      console.log('Updating analysis with filters:', {
        geographic, time, demographic, analysis
      });
      
      // Here you would update all charts and tables based on the filters
      // This is where the real-time filtering would happen
    }

    // File Upload Handler
    function handleFileUpload() {
      document.getElementById('fileInput').click();
    }

    // Process Uploaded File (CSV/XLSX/SAV guidance)
    function processFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.innerHTML = `
        <div class="spinner"></div>
        <div class="upload-text">Processing ${file.name}...</div>
        <div class="upload-subtext">Analyzing survey data and generating insights</div>
      `;
      const name = file.name.toLowerCase();
      if (name.endsWith('.csv')) {
        Papa.parse(file, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          worker: true,
          complete: function(results) {
            onPumfLoaded(file.name, results.data);
          },
          error: function(err) {
            showUploadError('CSV parse failed: ' + (err && err.message ? err.message : err));
          }
        });
      } else if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, { defval: null });
            onPumfLoaded(file.name, json);
          } catch (err) {
            showUploadError('XLSX parse failed: ' + err.message);
          }
        };
        reader.onerror = function() { showUploadError('Failed to read XLSX file.'); };
        reader.readAsArrayBuffer(file);
      } else if (name.endsWith('.sav')) {
        showUploadError('SPSS .sav is not supported in-browser. Please convert to CSV/XLSX (see guidance below).');
      } else {
        showUploadError('Unsupported file type. Please upload CSV or XLSX.');
      }
    }

    function showUploadError(msg) {
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.innerHTML = `
        <div style="color: #ef4444; font-size: 36px; margin-bottom: 0.5rem;">⚠️</div>
        <div class="upload-text" style="color: #ef4444;">${msg}</div>
        <div class="upload-subtext">Tip: Use R (haven) or Python (pyreadstat) to convert .sav</div>
      `;
    }

    async function loadPUMFFromURL(url) {
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.innerHTML = `
        <div class="spinner"></div>
        <div class="upload-text">Fetching from URL...</div>
        <div class="upload-subtext">Downloading file and parsing</div>
      `;
      try {
        const lower = url.toLowerCase();
        if (lower.endsWith('.csv')) {
          const resp = await fetch(url, { cache: 'no-store' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const text = await resp.text();
          const parsed = Papa.parse(text, { header: true, dynamicTyping: true, skipEmptyLines: true });
          onPumfLoaded(url.split('/').pop(), parsed.data);
        } else if (lower.endsWith('.xlsx') || lower.endsWith('.xls')) {
          const resp = await fetch(url, { cache: 'no-store' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const buf = await resp.arrayBuffer();
          const wb = XLSX.read(new Uint8Array(buf), { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { defval: null });
          onPumfLoaded(url.split('/').pop(), json);
        } else if (lower.endsWith('.sav')) {
          showUploadError('SPSS .sav is not supported in-browser due to format complexity and WASM size. Please convert to CSV/XLSX.');
        } else {
          throw new Error('Unsupported extension. Use .csv or .xlsx');
        }
      } catch (err) {
        showUploadError('URL load failed: ' + err.message + '. Ensure CORS is enabled.');
      }
    }

    function onPumfLoaded(name, rows) {
      if (!Array.isArray(rows) || rows.length === 0) { showUploadError('No rows found in file.'); return; }
      // Normalize keys to strings
      const normalized = rows.map(r => {
        const o = {};
        Object.keys(r || {}).forEach(k => { o[String(k).trim()] = r[k]; });
        return o;
      });
      window.pumfData = normalized;
      window.pumfColumns = Object.keys(normalized[0] || {});
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.innerHTML = `
        <div style=\"color: #10b981; font-size: 48px; margin-bottom: 1rem;\">✅</div>
        <div class=\"upload-text\" style=\"color: #10b981;\">Loaded ${name}</div>
        <div class=\"upload-subtext\">${normalized.length.toLocaleString()} records</div>
      `;
      document.getElementById('pumfControls').style.display = '';
      document.getElementById('pumfResults').style.display = '';
      populateVariableSelectors(window.pumfColumns);
      renderPreview(normalized);
      renderSummary(normalized);
      const status = document.getElementById('pumfStatus');
      const weightGuess = detectWeightColumn(window.pumfColumns);
      status.textContent = `Detected ${window.pumfColumns.length} variables. ${weightGuess ? 'Suggested weight: ' + weightGuess : 'No obvious weight detected.'}`;
      if (weightGuess) {
        const wSel = document.getElementById('weightVar');
        for (let i = 0; i < wSel.options.length; i++) {
          if (wSel.options[i].value === weightGuess) { wSel.selectedIndex = i; break; }
        }
      }
      // Auto-pick first two categorical-like variables for quick start
      autoSelectCategoricals();
      generateCrosstabAndRender();
    }

    function populateVariableSelectors(columns) {
      const selects = [document.getElementById('rowVar'), document.getElementById('colVar'), document.getElementById('weightVar')];
      selects.forEach(sel => { sel.innerHTML = columns.map(c => `<option value="${c}">${c}</option>`).join(''); });
    }

    function detectWeightColumn(columns) {
      const candidates = ['WGHT_PER','WTS_P','WTS','WEIGHT','WGHT','WT','WTP','W_F','FINALWGT','PUMFIDWT'];
      const lower = new Set(columns.map(c => c.toLowerCase()));
      for (const cand of candidates) {
        if (lower.has(cand.toLowerCase())) return columns.find(c => c.toLowerCase() === cand.toLowerCase());
      }
      return null;
    }

    function isCategoricalSampled(values) {
      const set = new Set();
      for (let i = 0; i < Math.min(values.length, 2000); i++) {
        const v = values[i];
        const key = v === null || v === undefined ? '' : String(v);
        set.add(key);
        if (set.size > 50) return false; // too many unique values
      }
      return true;
    }

    function autoSelectCategoricals() {
      const cols = window.pumfColumns || [];
      const data = window.pumfData || [];
      if (cols.length === 0 || data.length === 0) return;
      const sample = (col) => data.slice(0, 500).map(r => r[col]);
      const categoricalCols = cols.filter(c => isCategoricalSampled(sample(c)));
      const rowSel = document.getElementById('rowVar');
      const colSel = document.getElementById('colVar');
      if (categoricalCols[0]) rowSel.value = categoricalCols[0];
      if (categoricalCols[1]) colSel.value = categoricalCols[1];
    }

    function renderPreview(rows) {
      const table = document.getElementById('pumfPreviewTable');
      const cols = Object.keys(rows[0] || {});
      const head = `<thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr></thead>`;
      const body = `<tbody>${rows.slice(0, 10).map(r => `<tr>${cols.map(c => `<td>${safeCell(r[c])}</td>`).join('')}</tr>`).join('')}</tbody>`;
      table.innerHTML = head + body;
    }

    function renderSummary(rows) {
      const el = document.getElementById('pumfSummary');
      if (!el || !rows || rows.length === 0) return;
      const cols = Object.keys(rows[0] || {});
      const total = rows.length;
      const summaries = cols.slice(0, 12).map(col => {
        let missing = 0; const uniques = new Set();
        for (let i = 0; i < Math.min(total, 5000); i++) {
          const v = rows[i][col];
          if (v === null || v === undefined || v === '') missing++;
          uniques.add(String(v));
        }
        return { col, missing, uniques: uniques.size };
      });
      const html = `
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
          ${summaries.map(s => `
            <div style=\"background:#fff;border:1px solid var(--color-gray-200);border-radius:8px;padding:10px;\">
              <div style=\"font-weight:600;margin-bottom:6px;color:var(--color-gray-800);\">${escapeHtml(s.col)}</div>
              <div style=\"color:var(--color-gray-600);font-size:13px;\">Unique (sample): ${s.uniques}</div>
              <div style=\"color:var(--color-gray-600);font-size:13px;\">Missing (sample): ${s.missing}</div>
            </div>
          `).join('')}
        </div>
      `;
      el.innerHTML = html;
    }

    function safeCell(v) {
      if (v === null || v === undefined) return '';
      if (typeof v === 'number') return Number.isFinite(v) ? v : '';
      const s = String(v);
      return s.length > 200 ? s.slice(0, 200) + '…' : s;
    }

    function generateCrosstabAndRender() {
      const rowVar = document.getElementById('rowVar').value;
      const colVar = document.getElementById('colVar').value;
      const weightVar = document.getElementById('weightVar').value;
      const measureType = document.getElementById('measureType').value;
      const result = computeCrosstab(window.pumfData, rowVar, colVar, weightVar);
      renderCrosstabChart(result, measureType);
      renderCrosstabTable(result, measureType);
    }

    function computeCrosstab(rows, rowVar, colVar, weightVar) {
      const rowCats = [];
      const colCats = [];
      const rowIndex = new Map();
      const colIndex = new Map();
      const getIdx = (map, arr, key) => {
        if (map.has(key)) return map.get(key);
        const idx = arr.length; arr.push(key); map.set(key, idx); return idx;
      };
      const isMissing = (v) => v === null || v === undefined || v === '' || v === 'NA';
      // Build matrix
      const matrix = [];
      const totalsRow = [];
      let grandTotal = 0;
      for (let i = 0; i < rows.length; i++) {
        const r = rows[i];
        const rv = isMissing(r[rowVar]) ? '(Missing)' : String(r[rowVar]);
        const cv = isMissing(r[colVar]) ? '(Missing)' : String(r[colVar]);
        const w = Number(r[weightVar] ?? 1);
        if (!Number.isFinite(w)) continue;
        const ri = getIdx(rowIndex, rowCats, rv);
        const ci = getIdx(colIndex, colCats, cv);
        if (!matrix[ri]) matrix[ri] = new Array(colCats.length).fill(0);
        // Ensure dynamic expansion
        if (matrix[ri].length < colCats.length) {
          const need = colCats.length - matrix[ri].length;
          for (let k = 0; k < need; k++) matrix[ri].push(0);
        }
        matrix[ri][ci] += w;
        totalsRow[ci] = (totalsRow[ci] || 0) + w;
        grandTotal += w;
      }
      // Replace undefined rows with zeros for rectangular shape
      for (let ri = 0; ri < matrix.length; ri++) {
        matrix[ri] = matrix[ri] || [];
        if (matrix[ri].length < colCats.length) {
          const need = colCats.length - matrix[ri].length;
          for (let k = 0; k < need; k++) matrix[ri].push(0);
        }
      }
      // Row totals
      const totalsCol = matrix.map(row => row.reduce((a,b)=>a+b,0));
      return { rowCats, colCats, matrix, totalsRow: totalsRow.map(v=>v||0), totalsCol, grandTotal };
    }

    let pumfChartInstance = null;
    function renderCrosstabChart(result, measureType) {
      const labels = result.rowCats;
      const datasets = result.colCats.map((col, ci) => {
        const raw = result.matrix.map(row => row[ci]);
        let data = raw;
        if (measureType === 'rowPct') {
          data = raw.map((v, ri) => result.totalsCol[ri] ? (v / result.totalsCol[ri]) * 100 : 0);
        } else if (measureType === 'colPct') {
          const colTot = result.totalsRow[ci] || 1;
          data = raw.map(v => colTot ? (v / colTot) * 100 : 0);
        }
        return {
          label: col,
          data,
          backgroundColor: palette(ci),
          borderRadius: 3,
          borderSkipped: false
        };
      });
      const ctx = document.getElementById('pumfChart').getContext('2d');
      if (pumfChartInstance) pumfChartInstance.destroy();
      pumfChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const v = context.parsed.y;
                  if (document.getElementById('measureType').value === 'weighted') {
                    return `${context.dataset.label}: ${Math.round(v).toLocaleString()}`;
                  } else {
                    return `${context.dataset.label}: ${v.toFixed(1)}%`;
                  }
                }
              }
            }
          },
          scales: {
            y: {
              stacked: false,
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return document.getElementById('measureType').value === 'weighted' ? Math.round(value).toLocaleString() : value + '%';
                }
              }
            },
            x: { stacked: false }
          }
        }
      });
    }

    function palette(i) {
      const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16','#f43f5e','#a855f7','#22c55e'];
      return colors[i % colors.length];
    }

    function renderCrosstabTable(result, measureType) {
      const table = document.getElementById('pumfResultTable');
      const head = `<thead><tr><th>${escapeHtml('')}</th>${result.colCats.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}<th>Total</th></tr></thead>`;
      const bodyRows = result.rowCats.map((r, ri) => {
        const cells = result.colCats.map((c, ci) => formatMeasure(result.matrix[ri][ci], ri, ci, result, measureType));
        const totalCell = measureType === 'weighted' ? Math.round(result.totalsCol[ri]).toLocaleString() : '100.0%';
        return `<tr><td><strong>${escapeHtml(r)}</strong></td>${cells.map(c=>`<td>${c}</td>`).join('')}<td>${totalCell}</td></tr>`;
      }).join('');
      const totalRowCells = result.totalsRow.map((v, ci) => measureType === 'weighted' ? Math.round(v).toLocaleString() : '100.0%');
      const totalRow = `<tr><td><strong>Total</strong></td>${totalRowCells.map(c=>`<td>${c}</td>`).join('')}<td>${measureType === 'weighted' ? Math.round(result.grandTotal).toLocaleString() : '100.0%'}</td></tr>`;
      table.innerHTML = head + `<tbody>${bodyRows}${totalRow}</tbody>`;
    }

    function formatMeasure(value, ri, ci, res, type) {
      if (type === 'weighted') return Math.round(value).toLocaleString();
      if (type === 'rowPct') {
        const den = res.totalsCol[ri] || 1; return ((value/den)*100).toFixed(1) + '%';
      }
      if (type === 'colPct') {
        const den = res.totalsRow[ci] || 1; return ((value/den)*100).toFixed(1) + '%';
      }
      return value.toLocaleString();
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    function downloadCrosstabCSV() {
      const rows = [];
      const result = (function(){
        const rowVar = document.getElementById('rowVar').value;
        const colVar = document.getElementById('colVar').value;
        const weightVar = document.getElementById('weightVar').value;
        return computeCrosstab(window.pumfData, rowVar, colVar, weightVar);
      })();
      rows.push(['', ...result.colCats, 'Total']);
      for (let ri = 0; ri < result.rowCats.length; ri++) {
        const arr = [result.rowCats[ri]];
        for (let ci = 0; ci < result.colCats.length; ci++) arr.push(Math.round(result.matrix[ri][ci]));
        arr.push(Math.round(result.totalsCol[ri]));
        rows.push(arr);
      }
      rows.push(['Total', ...result.totalsRow.map(v=>Math.round(v)), Math.round(result.grandTotal)]);
      const csv = rows.map(r => r.map(v => typeof v === 'string' && v.includes(',') ? '"' + v.replace(/"/g,'""') + '"' : v).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'crosstab.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // Show Analysis Results
    function showAnalysisResults() {
      alert('Survey analysis results would be displayed here, including cross-tabulations, statistical tests, and predictive models.');
    }

    // Export Functions
    function exportChart(chartType) {
      console.log('Exporting chart:', chartType);
      alert(`Exporting ${chartType} chart data as CSV/PNG. This feature will provide high-resolution charts and raw data.`);
    }

    function exportTable() {
      console.log('Exporting table data');
      alert('Exporting detailed demographics table as CSV with full metadata and source information.');
    }

    function generateReport() {
      console.log('Generating comprehensive report');
      alert('Generating publication-ready PDF report with all visualizations, statistical analysis, and methodology notes.');
    }

    // Fullscreen Function
    function fullscreen(chartId) {
      console.log('Opening fullscreen view for:', chartId);
      alert(`Opening ${chartId} in fullscreen interactive mode with advanced filtering and annotation tools.`);
    }

    // Additional Functions
    function scheduleAnalysis() {
      alert('Schedule recurring analysis reports to be delivered to your email with the latest demographic updates.');
    }

    function requestCustomAnalysis() {
      alert('Request custom demographic analysis with specific parameters, statistical models, and research questions.');
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      if (query.length > 2) {
        console.log('Searching for:', query);
        // Implement search across all data and visualizations
      }
    });
  </script>
</body>

</html>
