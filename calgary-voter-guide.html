<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calgary Voter Guide - Find Your Ward & Candidates</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; animation: fadeInDown 0.8s ease; }
        .header h1 { font-size: 3rem; font-weight: 800; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.2rem; opacity: 0.95; }
        .main-card { background: white; border-radius: 24px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: fadeInUp 0.8s ease; margin-bottom: 30px; }
        .search-section { margin-bottom: 30px; }
        .input-group { position: relative; margin-bottom: 20px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; font-size: 0.95rem; }
        .address-input-wrapper { position: relative; }
        input[type="text"] { width: 100%; padding: 18px 50px 18px 20px; font-size: 1.1rem; border: 2px solid #e0e0e0; border-radius: 16px; transition: all 0.3s ease; background: #f8f9fa; }
        input[type="text"]:focus { outline: none; border-color: #667eea; background: white; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); }
        .input-icon { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); color: #999; }
        .autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e0e0e0; border-top: none; border-radius: 0 0 16px 16px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; }
        .autocomplete-dropdown.active { display: block; }
        .autocomplete-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
        .autocomplete-item:hover { background: #f8f9fa; }
        .autocomplete-item:last-child { border-bottom: none; }
        .search-btn { width: 100%; padding: 18px; font-size: 1.2rem; font-weight: 700; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 16px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .search-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .search-btn:active { transform: translateY(0); }
        .alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.4s ease; }
        .alert-error { background: #fee; border: 2px solid #fcc; color: #c33; }
        .alert-success { background: #efe; border: 2px solid #cfc; color: #3c3; }
        .alert-info { background: #eef; border: 2px solid #ccf; color: #33c; }
        .ward-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); animation: scaleIn 0.5s ease; }
        .ward-badge h2 { font-size: 1.5rem; margin-bottom: 10px; opacity: 0.9; }
        .ward-badge .ward-number { font-size: 4rem; font-weight: 900; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .candidates-section { margin-bottom: 30px; }
        .section-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 12px; }
        .section-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .mayor-icon { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .councillor-icon { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .candidate-list { display: flex; flex-direction: column; gap: 15px; }
        .candidate-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px 25px; border-radius: 16px; display: flex; align-items: center; gap: 20px; transition: all 0.3s ease; animation: slideInRight 0.5s ease; border: 2px solid transparent; }
        .candidate-card:hover { transform: translateX(8px); border-color: #667eea; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .rank-badge { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 900; flex-shrink: 0; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .candidate-name { font-size: 1.3rem; font-weight: 600; color: #333; }
        .loading { text-align: center; padding: 40px; color: #999; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        .info-note { background: #f8f9fa; padding: 16px; border-radius: 12px; border: 2px dashed #ddd; color: #555; margin-bottom: 20px; }
        .small { font-size: 12px; color: #6b7280; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px);} to {opacity: 1; transform: translateY(0);} }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px);} to {opacity: 1; transform: translateY(0);} }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px);} to {opacity: 1; transform: translateX(0);} }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px);} to {opacity: 1; transform: translateX(0);} }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9);} to {opacity: 1; transform: scale(1);} }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        @media (max-width: 768px) { .header h1 { font-size: 2rem;} .main-card { padding: 25px;} .ward-badge .ward-number { font-size: 3rem;} .section-title { font-size: 1.4rem;} }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó≥Ô∏è Calgary Voter Guide</h1>
            <p>Find your ward and recommended candidates</p>
        </div>

        <div class="main-card">
            <div class="info-note">Enter your address to find your Calgary ward.</div>

            <div class="search-section">
                <div class="input-group">
                    <label for="addressInput">Enter Your Address or Postal Code</label>
                    <div class="address-input-wrapper">
                        <input type="text" id="addressInput" placeholder="123 Main St SW, Calgary or T2P 3M5" autocomplete="off">
                        <span class="input-icon">üìç</span>
                        <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>
                <button class="search-btn" onclick="searchWard()">üîç Find My Ward & Candidates</button>
            </div>

            <div id="alertContainer"></div>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        const GOOGLE_MAPS_API_KEY = 'AIzaSyCUwE9QZHo61wVzuEyPLbRwGv2fUipWSg0';
        let wardIndex = { community: {} };
        let wardCommunities = {}; // ward -> [communities]
        let addressIndex = {}; // normalizedAddress -> community
        let autocompleteService = null;
        let placesService = null;
        let geocoder = null;

        function initGoogleMaps() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=initServices`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        function initServices() {
            autocompleteService = new google.maps.places.AutocompleteService();
            geocoder = new google.maps.Geocoder();
            const mapDiv = document.createElement('div');
            placesService = new google.maps.places.PlacesService(mapDiv);
        }

        // Load ward-to-community mapping from ward-specific files (1..14) or fallback JSON bundle if present
        async function loadWardCommunities() {
            try {
                const bundle = await fetch('assets/data/calgary/ward-communities.json', { cache: 'no-store' });
                if (bundle.ok) {
                    const data = await bundle.json();
                    wardIndex.community = {};
                    wardCommunities = {};
                    Object.entries(data || {}).forEach(([ward, communities]) => {
                        const list = (communities || []);
                        wardCommunities[ward] = list.slice();
                        list.forEach(name => {
                            wardIndex.community[normalizeKey(name)] = ward.toString().replace(/^(Ward\s*)/i,'').trim();
                        });
                    });
                } else {
                    // Try ward-#.json|.csv|.txt files, then PDF fallback
                    wardIndex.community = {};
                    wardCommunities = {};
                    const tryPaths = async (path) => {
                        const res = await fetch(path, { cache: 'no-store' });
                        if (!res.ok) return false;
                        const ct = res.headers.get('content-type')||'';
                        if (ct.includes('application/json')) {
                            const arr = await res.json();
                            if (Array.isArray(arr)) return arr;
                            return false;
                        } else {
                            const txt = await res.text();
                            // CSV (first column) or newline list
                            const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
                            if (lines.length===0) return [];
                            // If header looks like it, skip first when it contains letters beyond commas
                            const startIdx = lines[0].toLowerCase().includes('community') ? 1 : 0;
                            return lines.slice(startIdx).map(l=>l.split(',')[0].trim());
                        }
                    };
                    for (let i=1;i<=14;i++) {
                        const wardNum = String(i);
                        const candidates = [
                            `assets/data/calgary/wards/ward-${wardNum}.json`,
                            `assets/data/calgary/wards/ward-${wardNum}.csv`,
                            `assets/data/calgary/wards/ward-${wardNum}.txt`
                        ];
                        let list = null;
                        for (const p of candidates) {
                            try { const res = await tryPaths(p); if (res!==false) { list = res; break; } } catch {}
                        }
                        if (!list || !Array.isArray(list) || list.length===0) {
                            try { list = await extractCommunitiesFromPdf(wardNum); } catch {}
                        }
                        if (Array.isArray(list)) {
                            wardCommunities[wardNum] = list.slice();
                            list.forEach(name => { if (name) wardIndex.community[normalizeKey(name)] = wardNum; });
                        }
                    }
                }
                if (Object.keys(wardIndex.community).length>0) showAlert('Ward map loaded from repository.', 'success');
                else showAlert('Ward mapping files not found. Please add assets/data/calgary/wards/ward-#.json|.csv|.txt', 'info');
            } catch (e) {
                showAlert('Ward mapping files not found in repository.', 'info');
            }
        }

        // PDF fallback (uses pdf.js) to extract community names from ward-#-map.pdf
        async function extractCommunitiesFromPdf(wardNum) {
            if (!window['pdfjsLib']) return null;
            try {
                const url = `assets/data/calgary/pdfs/ward-${wardNum}-map.pdf`;
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                let text = '';
                for (let p = 1; p <= pdf.numPages; p++) {
                    const page = await pdf.getPage(p);
                    const content = await page.getTextContent();
                    text += content.items.map(i => i.str).join('\n') + '\n';
                }
                const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                const names = new Set();
                for (const line of lines) {
                    if (/COMM[_\s-]*CODE/i.test(line) || /NAME/i.test(line)) continue;
                    const m = line.match(/^([A-Z]{2,5})\s+(.+?)$/);
                    if (m) {
                        const name = m[2]
                          .replace(/\s{2,}/g, ' ')
                          .replace(/\s+\d+$/, '')
                          .trim();
                        if (name && name.length >= 3 && name.length <= 60) names.add(name);
                    }
                }
                const arr = Array.from(names);
                return arr.length ? arr : null;
            } catch (e) {
                return null;
            }
        }

        // Load address -> community index from repository (JSON or CSV)
        async function loadAddressIndex() {
            try {
                addressIndex = {};
                // Prefer JSON
                let res = await fetch('assets/data/calgary/addresses.json', { cache: 'no-store' });
                if (res.ok) {
                    const data = await res.json();
                    // Expect [{address, community}] or { address: community }
                    if (Array.isArray(data)) {
                        data.forEach(row => {
                            if (!row) return; const a = row.address||row.Address||row.ADDRESS; const c = row.community||row.Community||row.COMMUNITY;
                            if (a && c) addressIndex[normalizeAddressKey(a)] = c.toString().trim();
                        });
                    } else {
                        Object.entries(data||{}).forEach(([a,c])=>{ if (a && c) addressIndex[normalizeAddressKey(a)] = (c||'').toString().trim(); });
                    }
                    return;
                }
                // Try CSV
                res = await fetch('assets/data/calgary/addresses.csv', { cache: 'no-store' });
                if (res.ok) {
                    const text = await res.text();
                    const lines = text.split(/\r?\n/).filter(Boolean);
                    if (lines.length) {
                        const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
                        const ai = headers.findIndex(h=>['address','addr','full_address'].includes(h));
                        const ci = headers.findIndex(h=>['community','neighbourhood','neighborhood'].includes(h));
                        for (let i=1;i<lines.length;i++) {
                            const cols = lines[i].split(',');
                            const a = cols[ai]; const c = cols[ci];
                            if (a && c) addressIndex[normalizeAddressKey(a)] = c.trim();
                        }
                    }
                }
            } catch(e) {
                // ignore
            }
        }

        const addressInput = document.getElementById('addressInput');
        const dropdown = document.getElementById('autocompleteDropdown');
        let debounceTimer;
        addressInput.addEventListener('input', function(e){
            clearTimeout(debounceTimer);
            const value = e.target.value;
            if(!value || value.length<3 || !autocompleteService){ dropdown.classList.remove('active'); dropdown.innerHTML=''; return; }
            debounceTimer = setTimeout(()=>{
                const bounds = new google.maps.LatLngBounds(new google.maps.LatLng(50.8429,-114.3144), new google.maps.LatLng(51.2139,-113.8668));
                autocompleteService.getPlacePredictions({ input:value, componentRestrictions:{country:'ca'}, bounds }, displaySuggestions);
            },300);
        });
        function displaySuggestions(predictions,status){
            dropdown.innerHTML='';
            const ok = (google.maps.places.PlacesServiceStatus||{}).OK;
            if(status!==ok || !predictions || predictions.length===0){ dropdown.classList.remove('active'); return; }
            predictions.forEach(prediction=>{
                const item=document.createElement('div');
                item.className='autocomplete-item';
                item.textContent=prediction.description;
                item.addEventListener('click',()=>{
                    addressInput.value=prediction.description;
                    dropdown.classList.remove('active');
                    if(placesService && prediction.place_id){
                        placesService.getDetails({ placeId:prediction.place_id, fields:['address_components','geometry','name','formatted_address','types'] }, (place,detailStatus)=>{
                            if(detailStatus===(google.maps.places.PlacesServiceStatus||{}).OK && place){
                                const community=getCommunityFromComponents(place.address_components||[]);
                                if(community){ lookupByCommunity(community,{source:'Google Places (neighborhood)'}); }
                                else if(place.geometry && place.geometry.location){ reverseGeocode(place.geometry.location,'Google Places (reverse geocode)'); }
                                else { geocodeAddress(prediction.description); }
                            } else { geocodeAddress(prediction.description); }
                        });
                    } else { geocodeAddress(prediction.description); }
                });
                dropdown.appendChild(item);
            });
            dropdown.classList.add('active');
        }

        async function searchWard(){
            const address=addressInput.value.trim();
            if(!address){ showAlert('Please enter an address or postal code','error'); return; }
            if(Object.keys(wardIndex.community).length===0){ showAlert('Ward map not loaded yet. Please try again in a moment.', 'info'); return; }
            // Try direct address -> community mapping first
            const aiKey = normalizeAddressKey(address);
            if (addressIndex[aiKey]) {
                return lookupByCommunity(addressIndex[aiKey], { source: 'Address index' });
            }
            const postalCodePattern=/^[A-Za-z]\d[A-Za-z][\s-]?\d[A-Za-z]\d$/;
            if(postalCodePattern.test(address)){ lookupByPostalCode(address); }
            else { geocodeAddress(address); }
        }
        function geocodeAddress(address){
            showLoading();
            geocoder.geocode({ address: address + ', Calgary, AB' }, (results,status)=>{
                if(status==='OK' && results && results.length){
                    const best=results[0];
                    const community=getCommunityFromComponents(best.address_components||[]);
                    if(community){ lookupByCommunity(community,{source:'Google Geocoding'}); }
                    else if(best.geometry && best.geometry.location){ reverseGeocode(best.geometry.location,'Google Geocoding (reverse)'); }
                    else { showAlert('Could not determine community from address','error'); hideLoading(); }
                } else { showAlert('Address not found. Please try a different address.','error'); hideLoading(); }
            });
        }
        function reverseGeocode(latLng,source){
            geocoder.geocode({ location: latLng }, (results,status)=>{
                if(status==='OK' && results && results.length){
                    for(let i=0;i<results.length;i++){
                        const community=getCommunityFromComponents(results[i].address_components||[]);
                        if(community){ lookupByCommunity(community,{source}); return; }
                    }
                    showAlert('Could not determine community from reverse geocoding','error'); hideLoading();
                } else { showAlert('Reverse geocoding failed','error'); hideLoading(); }
            });
        }
        function getCommunityFromComponents(components){
            if(!components) return null; let neighborhood=null,sublocality=null,sublocalityLevel1=null,colloquial=null;
            components.forEach(component=>{
                const types=component.types||[];
                if(types.includes('neighborhood')) neighborhood=component.long_name;
                if(types.includes('sublocality')) sublocality=component.long_name;
                if(types.includes('sublocality_level_1')) sublocalityLevel1=component.long_name;
                if(types.includes('colloquial_area')) colloquial=component.long_name;
            });
            return neighborhood||sublocalityLevel1||sublocality||colloquial||null;
        }
        function lookupByCommunity(community,meta={}){
            const key=normalizeKey(community);
            const ward=wardIndex.community[key];
            if(ward){ displayResults(ward,{source:meta.source||'Community match',community}); }
            else { showAlert(`Community "${community}" not found in database`,'error'); hideLoading(); }
        }
        function lookupByPostalCode(postalCode){
            // For now, prefer address geocoding or neighborhood; postal-to-ward not supported without mapping file
            geocodeAddress(postalCode);
        }
        function displayResults(ward,options={}){
            hideLoading(); dropdown.classList.remove('active');
            const sourceNote=options.source?`<div class="alert alert-success"><span>‚úÖ</span><span>Matched by ${options.source}${options.community?` ‚Äì Community: ${options.community}`:''}${options.postal?` ‚Äì Postal: ${options.postal}`:''}</span></div>`:'';
            let html=`${sourceNote}<div class="ward-badge"><h2>Your Ward</h2><div class="ward-number">Ward ${ward}</div></div>`;
            document.getElementById('resultsContainer').innerHTML=html;
        }
        function showAlert(message,type){
            const alertContainer=document.getElementById('alertContainer');
            const icons={ error:'‚ùå', success:'‚úÖ', info:'‚ÑπÔ∏è' };
            alertContainer.innerHTML=`<div class="alert alert-${type}"><span>${icons[type]}</span><span>${message}</span></div>`;
            setTimeout(()=>{ alertContainer.innerHTML=''; },5000);
        }
        function showLoading(){ document.getElementById('resultsContainer').innerHTML=`<div class="loading"><div class="spinner"></div><p>Searching...</p></div>`; }
        function hideLoading(){ const loadingDiv=document.querySelector('.loading'); if(loadingDiv) loadingDiv.remove(); }
        function normalizeKey(value){ return value.toUpperCase().trim().replace(/\./g,'').replace(/-/g,' ').replace(/\s+/g,' ').replace(/\bN\s*E\b/g,'NE').replace(/\bN\s*W\b/g,'NW').replace(/\bS\s*E\b/g,'SE').replace(/\bS\s*W\b/g,'SW'); }
        function normalizeAddressKey(v){
            return (v||'')
                .toUpperCase()
                .replace(/CALGARY,?\s*AB/i,'')
                .replace(/,\s*/g,' ')
                .replace(/\./g,'')
                .replace(/\bST\b/g,'STREET')
                .replace(/\bAVE\b/g,'AVENUE')
                .replace(/\bRD\b/g,'ROAD')
                .replace(/\bDR\b/g,'DRIVE')
                .replace(/\bNE\b|\bN E\b/g,'NE')
                .replace(/\bNW\b|\bN W\b/g,'NW')
                .replace(/\bSE\b|\bS E\b/g,'SE')
                .replace(/\bSW\b|\bS W\b/g,'SW')
                .replace(/\s+/g,' ')
                .trim();
        }
        initGoogleMaps();
        loadWardCommunities();
        loadAddressIndex();
        document.addEventListener('click',function(e){ if(!addressInput.contains(e.target) && !dropdown.contains(e.target)){ dropdown.classList.remove('active'); } });
        addressInput.addEventListener('keypress',function(e){ if(e.key==='Enter'){ dropdown.classList.remove('active'); searchWard(); } });
    </script>
</body>
</html>
