<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calgary Voter Guide - Find Your Ward & Candidates</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; }
        .header h1 { font-size: 3rem; font-weight: 800; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.2rem; opacity: 0.95; }
        .main-card { background: white; border-radius: 24px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 30px; }
        .search-section { margin-bottom: 30px; }
        .input-group { position: relative; margin-bottom: 20px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; font-size: 0.95rem; }
        .address-input-wrapper { position: relative; }
        input[type="text"] { width: 100%; padding: 18px 50px 18px 20px; font-size: 1.1rem; border: 2px solid #e0e0e0; border-radius: 16px; transition: all 0.3s ease; background: #f8f9fa; }
        input[type="text"]:focus { outline: none; border-color: #667eea; background: white; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); }
        input[type="text"]:disabled { opacity: 0.6; cursor: not-allowed; }
        .input-icon { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); color: #999; }
        .autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e0e0e0; border-top: none; border-radius: 0 0 16px 16px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; }
        .autocomplete-dropdown.active { display: block; }
        .autocomplete-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
        .autocomplete-item:hover { background: #f8f9fa; }
        .autocomplete-item .main-text { font-weight: 600; color: #333; }
        .autocomplete-item .sub-text { font-size: 0.9rem; color: #666; margin-top: 2px; }
        .search-btn { width: 100%; padding: 18px; font-size: 1.2rem; font-weight: 700; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 16px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .search-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .search-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.4s ease; }
        .alert-error { background: #fee; border: 2px solid #fcc; color: #c33; }
        .alert-success { background: #efe; border: 2px solid #cfc; color: #3c3; }
        .alert-info { background: #eef; border: 2px solid #ccf; color: #33c; }
        .ward-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); animation: scaleIn 0.5s ease; }
        .ward-badge h2 { font-size: 1.5rem; margin-bottom: 10px; opacity: 0.9; }
        .ward-badge .ward-number { font-size: 4rem; font-weight: 900; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .candidates-section { margin-bottom: 30px; }
        .section-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 12px; }
        .section-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .mayor-icon { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .councillor-icon { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .candidate-list { display: flex; flex-direction: column; gap: 15px; }
        .candidate-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px 25px; border-radius: 16px; display: flex; align-items: center; gap: 20px; transition: all 0.3s ease; border: 2px solid transparent; animation: slideInRight 0.5s ease; }
        .candidate-card:hover { transform: translateX(8px); border-color: #667eea; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .candidate-name { font-size: 1.3rem; font-weight: 600; color: #333; text-decoration: none; }
        .candidate-name:hover { color: #667eea; }
        .loading { text-align: center; padding: 40px; color: #999; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        .info-note { background: #f8f9fa; padding: 16px; border-radius: 12px; border: 2px dashed #ddd; color: #555; margin-bottom: 20px; }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; margin-bottom: 10px; }
        .status-loading { background: #fef3c7; color: #92400e; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-error { background: #fee2e2; color: #991b1b; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { 
            .header h1 { font-size: 2rem; } 
            .main-card { padding: 25px; } 
            .ward-badge .ward-number { font-size: 3rem; } 
            .section-title { font-size: 1.4rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó≥Ô∏è Calgary Voter Guide</h1>
            <p>Find your ward and candidates</p>
        </div>

        <div class="main-card">
            <div class="info-note">
                <div id="statusBadge" class="status-badge status-loading">‚è≥ Loading address database...</div>
                <div>Enter your address to find your Calgary ward.</div>
            </div>

            <div class="search-section">
                <div class="input-group">
                    <label for="addressInput">Enter Your Address</label>
                    <div class="address-input-wrapper">
                        <input type="text" id="addressInput" placeholder="123 Main St SW, Calgary" autocomplete="off" disabled>
                        <span class="input-icon">üìç</span>
                        <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>
                <button class="search-btn" onclick="searchWard()" disabled id="searchBtn">üîç Find My Ward & Candidates</button>
            </div>

            <div id="alertContainer"></div>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        const SUPABASE_DATA_URL = 'https://ajgqyygtstihrwjovhes.supabase.co/storage/v1/object/public/YYC%20addresses/filtered_property_data.json';
        let addressData = [];
        let addressIndex = new Map();
        let wardIndex = { community: {} };
        let trackerCandidates = null;
        let debounceTimer;
        const addressInput = document.getElementById('addressInput');
        const searchBtn = document.getElementById('searchBtn');
        const dropdown = document.getElementById('autocompleteDropdown');
        const statusBadge = document.getElementById('statusBadge');
        async function init() {
            console.log('=== Calgary Voter Guide Initializing ===');
            await Promise.all([loadAddressData(), loadWardCommunities(), loadTrackerCandidates()]);
        }
        function updateStatus(status, text) {
            statusBadge.className = `status-badge status-${status}`;
            statusBadge.textContent = text;
        }
        async function loadAddressData() {
            try {
                updateStatus('loading', '‚è≥ Loading addresses...');
                console.log('Fetching:', SUPABASE_DATA_URL);
                const response = await fetch(SUPABASE_DATA_URL, { method: 'GET', cache: 'default' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const rawText = await response.text();
                console.log('Downloaded:', (rawText.length / 1024).toFixed(0), 'KB');
                let data;
                try { data = JSON.parse(rawText); } catch { data = rawText.split('\n').filter(line => line.trim()).map(line => { try { return JSON.parse(line); } catch { return null; } }).filter(Boolean); }
                addressData = Array.isArray(data) ? data : (data.records || []);
                console.log('Total records:', addressData.length);
                let indexed = 0;
                addressData.forEach(record => {
                    const address = getField(record, ['address', 'Address', 'ADDRESS', 'full_address', 'street_address']);
                    const community = getField(record, ['community', 'Community', 'COMMUNITY', 'NEIGHBOURHOOD', 'Neighbourhood']);
                    if (address && community) { addressIndex.set(normalizeAddress(address), { address: address, community: community }); indexed++; }
                });
                console.log('Indexed:', indexed, 'addresses');
                updateStatus('ready', '‚úÖ Ready');
                addressInput.disabled = false;
                searchBtn.disabled = false;
            } catch (error) {
                console.error('Load error:', error);
                updateStatus('error', '‚ùå Failed to load');
                showAlert('Failed to load address database: ' + error.message, 'error');
            }
        }
        function getField(obj, fieldNames) { for (const name of fieldNames) { if (obj[name]) return String(obj[name]).trim(); } return ''; }
        function normalizeAddress(addr) { return addr.toUpperCase().replace(/CALGARY,?\s*AB/gi, '').replace(/,/g, ' ').replace(/\./g, '').replace(/\bSTREET\b/g, 'ST').replace(/\bAVENUE\b/g, 'AVE').replace(/\bROAD\b/g, 'RD').replace(/\bDRIVE\b/g, 'DR').replace(/\bN\s*E\b/g, 'NE').replace(/\bN\s*W\b/g, 'NW').replace(/\bS\s*E\b/g, 'SE').replace(/\bS\s*W\b/g, 'SW').replace(/\s+/g, ' ').trim(); }
        addressInput.addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            const value = e.target.value.trim();
            if (value.length < 3) { dropdown.classList.remove('active'); return; }
            debounceTimer = setTimeout(() => {
                const searchTerm = normalizeAddress(value);
                const matches = [];
                for (const [normalizedAddr, data] of addressIndex.entries()) { if (normalizedAddr.includes(searchTerm)) { matches.push(data); if (matches.length >= 10) break; } }
                displaySuggestions(matches);
            }, 200);
        });
        function displaySuggestions(matches) {
            dropdown.innerHTML = '';
            if (!matches || matches.length === 0) { dropdown.classList.remove('active'); return; }
            matches.forEach(match => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `<div class="main-text">${match.address}</div><div class="sub-text">${match.community}</div>`;
                item.addEventListener('click', () => { addressInput.value = match.address; dropdown.classList.remove('active'); lookupByCommunity(match.community, match.address); });
                dropdown.appendChild(item);
            });
            dropdown.classList.add('active');
        }
        function searchWard() {
            const address = addressInput.value.trim();
            if (!address) { showAlert('Please enter an address', 'error'); return; }
            const normalized = normalizeAddress(address);
            const match = addressIndex.get(normalized);
            if (match) { lookupByCommunity(match.community, match.address); return; }
            for (const [normalizedAddr, data] of addressIndex.entries()) { if (normalizedAddr.includes(normalized)) { lookupByCommunity(data.community, data.address); return; } }
            showAlert('Address not found. Please select from suggestions.', 'error');
        }
        function lookupByCommunity(community, address) {
            const key = normalizeKey(community);
            const ward = wardIndex.community[key];
            if (ward) { displayResults(ward, { community, address }); } else { showAlert(`Community "${community}" not mapped to ward`, 'error'); }
        }
        function displayResults(ward, options = {}) {
            dropdown.classList.remove('active');
            const { mayors, councillors } = getCandidatesForWard(ward);
            let sourceText = 'Address matched';
            if (options.address) sourceText += ` ‚Äì ${options.address}`;
            if (options.community) sourceText += ` (${options.community})`;
            let html = `<div class="alert alert-success"><span>‚úÖ</span><span>${sourceText}</span></div>`;
            html += `<div class="ward-badge"><h2>Your Ward</h2><div class="ward-number">Ward ${ward}</div></div>`;
            if (mayors.length > 0) html += renderCandidateSection('Mayor Candidates', 'mayor-icon', mayors, 'City-wide');
            if (councillors.length > 0) html += renderCandidateSection('Councillor Candidates', 'councillor-icon', councillors, `Ward ${ward}`);
            if (mayors.length === 0 && councillors.length === 0) html += `<div class="alert alert-info"><span>‚ÑπÔ∏è</span><span>Candidate data not available</span></div>`;
            document.getElementById('resultsContainer').innerHTML = html;
        }
        function renderCandidateSection(title, iconClass, candidates, wardLabel) {
            let html = `<div class="candidates-section"><h3 class="section-title"><span class="section-icon ${iconClass}">üë§</span>${title} (${wardLabel})</h3><div class="candidate-list">`;
            candidates.forEach(candidate => {
                const name = candidate.url ? `<a href="${candidate.url}" target="_blank" rel="noopener" class="candidate-name">${candidate.name}</a>` : `<span class="candidate-name">${candidate.name}</span>`;
                html += `<div class="candidate-card">${name}</div>`;
            });
            html += `</div></div>`;
            return html;
        }
        async function loadWardCommunities() {
            try {
                for (let i = 1; i <= 14; i++) {
                    try {
                        const res = await fetch(`assets/data/calgary/wards/ward-${i}.json`);
                        if (res.ok) {
                            const communities = await res.json();
                            communities.forEach(name => { wardIndex.community[normalizeKey(name)] = String(i); });
                        }
                    } catch (e) { console.warn(`Ward ${i} file not found`); }
                }
                console.log('Ward mapping loaded:', Object.keys(wardIndex.community).length, 'communities');
            } catch (e) { console.error('Failed to load ward mapping:', e); }
        }
        async function loadTrackerCandidates() {
            try {
                const res = await fetch('calgary-2025.html');
                if (!res.ok) return;
                const html = await res.text();
                const re = /const\s+candidates\s*=\s*\[(.*?)\];/s;
                const m = re.exec(html);
                if (!m) return;
                trackerCandidates = Function('"use strict"; return [' + m[1] + '];')();
                console.log('Loaded candidates:', trackerCandidates.length);
            } catch (e) { console.error('Failed to load candidates:', e); }
        }
        function getCandidatesForWard(ward) {
            const wardStr = String(ward);
            const empty = { mayors: [], councillors: [] };
            if (!Array.isArray(trackerCandidates)) return empty;
            return { mayors: trackerCandidates.filter(c => c.position === 'Mayor'), councillors: trackerCandidates.filter(c => c.position === 'Councillor' && String(c.ward) === wardStr) };
        }
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const icons = { error: '‚ùå', success: '‚úÖ', info: '‚ÑπÔ∏è' };
            alertContainer.innerHTML = `<div class="alert alert-${type}"><span>${icons[type]}</span><span>${message}</span></div>`;
            setTimeout(() => { alertContainer.innerHTML = ''; }, 5000);
        }
        function normalizeKey(value) { return value.toUpperCase().trim().replace(/\./g, '').replace(/-/g, ' ').replace(/\//g, ' ').replace(/\s+/g, ' ').replace(/\bN\s*E\b/g, 'NE').replace(/\bN\s*W\b/g, 'NW').replace(/\bS\s*E\b/g, 'SE').replace(/\bS\s*W\b/g, 'SW'); }
        document.addEventListener('click', function(e) { if (!addressInput.contains(e.target) && !dropdown.contains(e.target)) { dropdown.classList.remove('active'); } });
        addressInput.addEventListener('keypress', function(e) { if (e.key === 'Enter' && !addressInput.disabled) { dropdown.classList.remove('active'); searchWard(); } });
        init();
    </script>
</body>
</html>
